version: "3"

services:
  hub:
    image: seleniarm/hub:4.20
    ports:
      - "4444:4444"
    environment:
      - SE_NODE_MAX_SESSIONS=4         # Set the max sessions hub can handle concurrently
      - GRID_BROWSER_TIMEOUT=300000     # Timeout settings for browsers, in milliseconds
      - GRID_TIMEOUT=300000             # Session timeout settings for grid, in milliseconds

  chrome:
    image: seleniarm/node-chromium:4.20
    shm_size: '5g'
    deploy:
      replicas: 3
    depends_on:
      - hub
    environment:
      - SE_EVENT_BUS_HOST=hub
      - SE_EVENT_BUS_PUBLISH_PORT=4442
      - SE_EVENT_BUS_SUBSCRIBE_PORT=4443
      - SE_NODE_MAX_INSTANCES=4         # Max instances per node
      - SE_NODE_MAX_SESSIONS=4         # Max sessions per node to avoid overload

  firefox:
    image: seleniarm/node-firefox:4.20
    shm_size: '5g'
    deploy:
      replicas: 0
    depends_on:
      - hub
    environment:
      - SE_EVENT_BUS_HOST=hub
      - SE_EVENT_BUS_PUBLISH_PORT=4442
      - SE_EVENT_BUS_SUBSCRIBE_PORT=4443
      - SE_NODE_MAX_INSTANCES=4         # Max instances per node
      - SE_NODE_MAX_SESSIONS=4          # Max sessions per node to avoid overload
